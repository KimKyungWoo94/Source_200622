/****************************************************************************************
	시스템 헤더

****************************************************************************************/
#include <sys/ipc.h>
#include <sys/shm.h>
#include <string.h> 
#include <errno.h>

/****************************************************************************************
	프로젝트 헤더

****************************************************************************************/
#include <shm.h>

/****************************************************************************************
	상수

****************************************************************************************/


/****************************************************************************************
	매크로

****************************************************************************************/


/****************************************************************************************
	유형 정의

****************************************************************************************/


/****************************************************************************************
	열거형

****************************************************************************************/


/****************************************************************************************
	구조체

****************************************************************************************/


/****************************************************************************************
	전역변수

****************************************************************************************/


/****************************************************************************************
	함수원형(지역/전역)

****************************************************************************************/


/****************************************************************************************

	InitShm()
		- 공유 메모리 초기화

	arguments

	return
		0	성공
		-1 	실패

****************************************************************************************/
int32_t InitShm(int* shmid, char **shmPtr)
{
	printf("Initializing shared memory\n");

	/*----------------------------------------------------------------------------------*/
	/* 공유 메모리 생성 */
	/*----------------------------------------------------------------------------------*/
	*shmid	=	shmget((key_t)GPSD_CHECK_KEY, sizeof(bool), 0666 | IPC_CREAT);
	if(*shmid == -1)
	{
		printf("Fail to create shared memory: %s\n", strerror(errno));
		return	-1;
	}
	/*----------------------------------------------------------------------------------*/

	/*----------------------------------------------------------------------------------*/
	/* 공유 메모리 포인터 설정 */
	/*----------------------------------------------------------------------------------*/
	*shmPtr	=	(char *)shmat(*shmid, NULL, 0);
	if(*shmPtr == (char *)-1)
	{
		printf("Fail to attach shared memory: %s\n", strerror(errno));
		return	-1;
	}
	/*----------------------------------------------------------------------------------*/

	/*----------------------------------------------------------------------------------*/
	/* 메모리 값 초기화 */
	/*----------------------------------------------------------------------------------*/
	memset(*shmPtr, 0, sizeof(bool));
	/*----------------------------------------------------------------------------------*/

	printf("Success to initialize shared memory\n");
	return	0;
}


/****************************************************************************************

	ReleaseShm()
		- 공유 메모리 해제

	arguments

	return
		0	성공
		-1 	실패

****************************************************************************************/
int32_t ReleaseShm(char *shmPtr)
{
	printf("Releasing shared memory\n");

	if(!shmPtr)
	{
		printf("Null shared memory pointer");
		return	-1;
	}

	if (-1 == shmdt(shmPtr))
	{
		printf("Fail to detach shared memory: %s\n", strerror(errno));
		return	-1;
	}
	printf("Success to detach shared memory\n");

	return	0;
}


